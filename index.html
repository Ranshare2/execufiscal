<!DOCTYPE html>
<html lang="pt-br">
<head>
    <!-- Meta Tags Essenciais -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Gerenciamento de Petições</title>

    <!-- Links para CSS Externos -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/boxicons@2.0.7/css/boxicons.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css" rel="stylesheet">

    <!-- Fonte Externa -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">

    <!-- Estilos Personalizados -->
    <style>
        /* Variáveis de Cores e Gradientes */
        :root {
            --primary-gradient: linear-gradient(135deg, #1F3C88, #1E3A86); /* Azul Escuro */
            --secondary-gradient: linear-gradient(135deg, #FFFFFF, #F5F5F5); /* Branco para Cinza Claro */
            --accent-gradient: linear-gradient(135deg, #FFC107, #FFB300); /* Dourado */
            --background-color: #F9FAFB; /* Fundo Muito Claro */
            --text-color: #1F2937; /* Cinza Escuro */
            --card-bg: #FFFFFF; /* Branco */
        }

        /* Tipografia Global */
        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--background-color);
            color: var(--text-color);
        }

        /* Navbar Personalizada */
        .navbar {
            background: var(--primary-gradient);
            padding: 1rem 0;
        }

        .navbar-brand, .nav-link {
            color: #ffffff !important;
            font-weight: 500;
        }

        .navbar-brand i {
            color: #FFC107; /* Ícone em Dourado */
        }

        .nav-link:hover {
            color: #FFC107 !important;
        }

        /* Cartões de Estatísticas */
        .card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            overflow: hidden;
            background-color: var(--card-bg);
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.15);
        }

        .stat-card {
            background: var(--secondary-gradient);
            color: var(--text-color);
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            padding: 2rem 1rem;
        }

        .stat-card i {
            font-size: 3rem;
            color: #1F3C88;
            margin-bottom: 1rem;
        }

        .stat-card .card-title {
            font-size: 1.2rem;
            font-weight: 600;
        }

        .stat-card .card-text {
            font-size: 2rem;
            font-weight: 700;
        }

        /* Área de Upload */
        .upload-area {
            border: 2px dashed #A0AEC0;
            border-radius: 15px;
            padding: 2rem;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
            background-color: #FFFFFF;
        }

        .upload-area:hover {
            border-color: #1F3C88;
            background-color: #E2E8F0;
        }

        .upload-area i {
            font-size: 3rem;
            color: #1F3C88;
            margin-bottom: 1rem;
        }

        /* Tabela de Dados */
        .table-responsive {
            background-color: var(--card-bg);
            border-radius: 15px;
            overflow: hidden;
            padding: 1rem;
        }

        .table thead th {
            background: var(--primary-gradient);
            color: #ffffff;
            border: none;
            padding: 1rem;
            font-weight: 600;
        }

        .table-hover tbody tr:hover {
            background-color: #E2E8F0;
        }

        .table tbody td {
            padding: 1rem;
            vertical-align: middle;
        }

        /* Botões Personalizados */
        .btn-primary {
            background: var(--primary-gradient);
            border: none;
            transition: opacity 0.3s ease;
            padding: 0.5rem 1rem;
            border-radius: 30px;
        }

        .btn-primary:hover {
            opacity: 0.9;
        }

        .btn-success {
            background: linear-gradient(135deg, #38A169, #2F855A);
            border: none;
            color: #ffffff;
            transition: opacity 0.3s ease;
            padding: 0.5rem 1rem;
            border-radius: 30px;
        }

        .btn-success:hover {
            opacity: 0.9;
        }

        .btn-warning {
            background: var(--accent-gradient);
            border: none;
            color: #ffffff;
            transition: opacity 0.3s ease;
            padding: 0.5rem 1rem;
            border-radius: 30px;
        }

        .btn-warning:hover {
            opacity: 0.9;
        }

        /* Status */
        .status-pending {
            background-color: rgba(255, 193, 7, 0.1);
            color: #FFC107;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            text-align: center;
            font-weight: 500;
        }

        .status-completed {
            background-color: rgba(56, 161, 105, 0.1);
            color: #38A169;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            text-align: center;
            font-weight: 500;
        }

        /* Footer */
        .footer {
            background: var(--primary-gradient);
            color: #ffffff;
            padding: 2rem 0;
        }

        .footer h5 {
            font-weight: 600;
        }

        .footer a {
            color: #ffffff;
            text-decoration: none;
            transition: color 0.3s ease;
        }

        .footer a:hover {
            color: #FFC107;
        }

        /* Toastify */
        .toastify {
            padding: 12px 20px;
            color: #ffffff;
            display: inline-block;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
            background: var(--primary-gradient);
            border-radius: 8px;
            font-family: 'Poppins', sans-serif;
            font-size: 16px;
        }

        .toastify.toast-success {
            background: linear-gradient(135deg, #38A169, #2F855A);
        }

        .toastify.toast-error {
            background: var(--accent-gradient);
        }

        .toastify .toast-close {
            opacity: 0.7;
            padding: 0 5px;
        }

        .toastify .toast-close:hover {
            opacity: 1;
        }

        /* Scrollbar Personalizado */
        ::-webkit-scrollbar {
            width: 10px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 5px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        /* Container de Pesquisa e Filtro */
        .search-filter-container {
            background-color: var(--card-bg);
            border-radius: 15px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .filter-btn {
            border-radius: 20px;
            padding: 0.5rem 1rem;
            margin-right: 0.5rem;
            border: none;
            background-color: #E2E8F0;
            color: var(--text-color);
            transition: background-color 0.3s ease;
        }

        .filter-btn:hover {
            background-color: #CBD5E0;
        }

        /* Paginação */
        .pagination {
            background-color: var(--card-bg);
            border-radius: 15px;
            padding: 1rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .pagination .page-link {
            border-radius: 50%;
            margin: 0 0.2rem;
            color: var(--text-color);
            border: none;
            background-color: #E2E8F0;
            transition: background-color 0.3s ease;
        }

        .pagination .page-link:hover {
            background-color: #CBD5E0;
        }

        /* Modal de Petição */
        .modal-xl {
            max-width: 90%;
        }

        .petition-container {
            max-height: 70vh;
            overflow-y: auto;
            font-family: 'Times New Roman', Times, serif;
            font-size: 16px;
            line-height: 1.8;
        }

        .petition-text h2 {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 20px;
        }

        .petition-text h3 {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 15px;
        }

        .petition-text p {
            margin-bottom: 15px;
            text-align: justify;
        }

        .petition-text blockquote {
            margin: 15px 0;
            padding: 10px 20px;
            border-left: 5px solid #1F3C88;
            background-color: #E2E8F0;
        }

        .petition-text ol, .petition-text ul {
            margin-bottom: 15px;
            padding-left: 20px;
        }

        .petition-text li {
            margin-bottom: 10px;
        }

        .petition-text strong {
            font-weight: bold;
        }

        .btn-close-white {
            color: white;
        }

        /* Responsividade */
        @media (max-width: 767px) {
            .stat-card {
                padding: 1.5rem 1rem;
            }

            .stat-card i {
                font-size: 2.5rem;
            }

            .stat-card .card-text {
                font-size: 1.5rem;
            }
        }
    </style>
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container">
            <a class="navbar-brand" href="#">
                <i class="bx bx-file me-2"></i>
                Sistema de Gerenciamento de Petições
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="bx bx-menu" style="color: #fff;"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="#" data-bs-toggle="modal" data-bs-target="#helpModal">
                            <i class="bx bx-help-circle me-1"></i>Ajuda
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Conteúdo Principal -->
    <div class="container my-5">
        <!-- Cartões de Estatísticas -->
        <div class="row mb-4">
            <div class="col-md-3 mb-4">
                <div class="card stat-card">
                    <div class="card-body text-center">
                        <i class="bx bx-file mb-3"></i>
                        <h5 class="card-title">Total de Petições</h5>
                        <p class="card-text" id="totalPetitions">0</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3 mb-4">
                <div class="card stat-card">
                    <div class="card-body text-center">
                        <i class="bx bx-time mb-3"></i>
                        <h5 class="card-title">Petições Pendentes</h5>
                        <p class="card-text" id="pendingPetitions">0</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3 mb-4">
                <div class="card stat-card">
                    <div class="card-body text-center">
                        <i class="bx bx-check-circle mb-3"></i>
                        <h5 class="card-title">Petições Concluídas</h5>
                        <p class="card-text" id="completedPetitions">0</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3 mb-4">
                <div class="card stat-card">
                    <div class="card-body text-center">
                        <i class="bx bx-money mb-3"></i>
                        <h5 class="card-title">Valor Total</h5>
                        <p class="card-text" id="totalValue">R$ 0,00</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Área de Upload -->
        <div class="card mb-4">
            <div class="card-body">
                <h5 class="card-title mb-4">Importar Dados</h5>
                <div class="upload-area" id="uploadArea">
                    <i class="bx bx-cloud-upload"></i>
                    <h4>Arraste e solte o arquivo Excel aqui</h4>
                    <p>ou</p>
                    <label for="xlsxInput" class="btn btn-primary">Selecione o arquivo</label>
                    <input type="file" id="xlsxInput" class="d-none" accept=".xlsx">
                </div>
            </div>
        </div>

        <!-- Gerenciamento de Petições -->
        <div class="card">
            <div class="card-body">
                <h5 class="card-title mb-4">Gerenciamento de Petições</h5>
                <div class="search-filter-container">
                    <div class="row align-items-center">
                        <div class="col-md-6 mb-3 mb-md-0">
                            <div class="input-group">
                                <span class="input-group-text"><i class="bx bx-search"></i></span>
                                <input type="text" id="searchInput" class="form-control" placeholder="Buscar petições" oninput="searchTable()">
                            </div>
                        </div>
                        <div class="col-md-6 text-md-end">
                            <button class="btn filter-btn" onclick="filterTable('all')">Todas</button>
                            <button class="btn filter-btn" onclick="filterTable('pending')">Pendentes</button>
                            <button class="btn filter-btn" onclick="filterTable('completed')">Concluídas</button>
                        </div>
                    </div>
                </div>

                <div class="table-responsive">
                    <table id="dataTable" class="table table-hover">
                        <thead>
                            <tr>
                                <th>Certidão</th>
                                <th>Nome do Contribuinte</th>
                                <th>CPF/CNPJ</th>
                                <th>Endereço</th>
                                <th>Total (Valor atual)</th>
                                <th>Status</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Conteúdo Dinâmico -->
                        </tbody>
                    </table>
                </div>

                <nav aria-label="Paginação da tabela" class="mt-4">
                    <ul class="pagination justify-content-center" id="pagination"></ul>
                </nav>
            </div>
        </div>
    </div>

    <!-- Modal de Ajuda -->
    <div class="modal fade" id="helpModal" tabindex="-1" aria-labelledby="helpModalLabel">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 id="helpModalLabel">Ajuda - Como Usar o Sistema</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <!-- Conteúdo da Ajuda -->
                    <h6>1. Importando Dados</h6>
                    <p>Para importar dados de petições:</p>
                    <ol>
                        <li>Arraste e solte o arquivo Excel na área designada ou clique em "Selecione o arquivo".</li>
                        <li>Aguarde o processamento e carregamento dos dados na tabela.</li>
                    </ol>

                    <h6>2. Navegando pelo Dashboard</h6>
                    <p>O dashboard fornece uma visão geral das suas petições:</p>
                    <ul>
                        <li>Total de Petições: Número total de petições no sistema.</li>
                        <li>Petições Pendentes: Número de petições ainda não finalizadas.</li>
                        <li>Petições Concluídas: Número de petições concluídas.</li>
                        <li>Valor Total: Soma dos valores de todas as petições.</li>
                    </ul>

                    <h6>3. Gerenciando Petições</h6>
                    <p>Na tabela de petições, você pode:</p>
                    <ul>
                        <li>Buscar petições específicas usando a barra de pesquisa.</li>
                        <li>Filtrar petições por status (Todas, Pendentes, Concluídas).</li>
                        <li>Gerar uma petição clicando no botão "Petição".</li>
                        <li>Alterar o status de uma petição clicando no botão "Concluir" ou "Reabrir".</li>
                    </ul>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Petição -->
    <div class="modal fade" id="petitionModal" tabindex="-1" aria-labelledby="petitionModalLabel">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 id="petitionModalLabel">Petição Gerada</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="petition-container bg-light p-4 rounded">
                        <div id="petitionText" class="petition-text"></div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                    <button type="button" class="btn btn-primary" onclick="copyPetitionText()">
                        <i class="bx bx-copy me-2"></i>Copiar Texto
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="footer mt-5">
        <div class="container">
            <div class="row">
                <div class="col-md-6">
                    <h5>Sistema de Gerenciamento de Petições</h5>
                    <p>Desenvolvido para otimizar o processo de geração e gerenciamento de petições.</p>
                </div>
                <div class="col-md-3">
                    <h5>Links Úteis</h5>
                    <ul class="list-unstyled">
                        <li><a href="#">Termos de Uso</a></li>
                        <li><a href="#">Política de Privacidade</a></li>
                    </ul>
                </div>
                <div class="col-md-3">
                    <h5>Contato</h5>
                    <p>Email: suporte@sistema.com<br>Tel: (00) 1234-5678</p>
                </div>
            </div>
        </div>
    </footer>

    <!-- Scripts Externos -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
    let tableData = [];
let currentPage = 1;
const rowsPerPage = 10;

function handleFileUpload() {
  const fileInput = document.getElementById('xlsxInput');
  const file = fileInput.files[0];
  if (file) {
    const reader = new FileReader();
    reader.onload = function (e) {
      try {
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, { type: 'array' });
        const sheetName = workbook.SheetNames[0];
        const worksheet = workbook.Sheets[sheetName];

        // Converte os dados e normaliza os nomes das colunas
        tableData = XLSX.utils.sheet_to_json(worksheet).map((row) => {
          // Normaliza os nomes das colunas para garantir consistência
          return {
            'Certidão Número':
              row['Certidão Número'] || row['CDA'] || row['Certidão'] || '',
            'Nome do Contribuinte': row['Nome do Contribuinte'] || '',
            'CPF/CNPJ': row['CPF/CNPJ'] || 'Não informado',
            Endereço: row['Endereço'] || '',
            'Total (Valor atual)':
              row['Total (Valor atual)'] || 'Não informado',
            status: 'Pendente',
          };
        });

        displayTable();
        updateDashboard();
        showToast('Dados importados com sucesso!', 'success');
      } catch (error) {
        console.error('Erro ao processar arquivo:', error);
        showToast('Erro ao processar o arquivo. Verifique o formato.', 'error');
      }
    };
    reader.onerror = function () {
      showToast('Erro ao ler o arquivo.', 'error');
    };
    reader.readAsArrayBuffer(file);
  }
}

function displayTable() {
  const table = document
    .getElementById('dataTable')
    .getElementsByTagName('tbody')[0];
  table.innerHTML = '';
  const start = (currentPage - 1) * rowsPerPage;
  const end = start + rowsPerPage;
  const pageData = tableData.slice(start, end);

  pageData.forEach((row, index) => {
    const newRow = table.insertRow();
    newRow.className = `table-row-hover ${
      row.status === 'Pendente' ? 'status-pending' : 'status-completed'
    }`;

    // Verifica e formata os dados
    const certidao =
      row['Certidão Número'] || row['CDA'] || row['Certidão'] || '';
    const nome = row['Nome do Contribuinte'] || '';
    const cpf = row['CPF/CNPJ'] || '';
    const endereco = row['Endereço'] || '';
    const valor = row['Total (Valor atual)'] || '';

    newRow.innerHTML = `
            <td class="align-middle">
                <span class="fw-semibold">${certidao}</span>
            </td>
            <td class="align-middle">
                <span class="fw-semibold">${nome}</span>
            </td>
            <td class="align-middle">
                <span>${cpf}</span>
            </td>
            <td class="align-middle">
                <div class="text-wrap">
                    ${endereco}
                </div>
            </td>
            <td class="align-middle text-end fw-bold">
                ${valor}
            </td>
            <td class="align-middle">
                <span class="badge ${
                  row.status === 'Pendente' ? 'bg-warning' : 'bg-success'
                }">${row.status}</span>
            </td>
            <td class="align-middle">
                <div class="btn-group" role="group">
                    <button class="btn btn-primary btn-sm" 
                            onclick="generatePetition(${start + index})"
                            title="Gerar Petição">
                        <i class="bx bx-file-blank"></i>
                        <span class="d-none d-md-inline ms-1">Petição</span>
                    </button>
                    <button class="btn btn-${
                      row.status === 'Pendente' ? 'success' : 'warning'
                    } btn-sm" 
                            onclick="toggleStatus(${start + index})"
                            title="${
                              row.status === 'Pendente' ? 'Concluir' : 'Reabrir'
                            }">
                        <i class="bx bx-${
                          row.status === 'Pendente' ? 'check' : 'refresh'
                        }"></i>
                        <span class="d-none d-md-inline ms-1">
                            ${
                              row.status === 'Pendente' ? 'Concluir' : 'Reabrir'
                            }
                        </span>
                    </button>
                </div>
            </td>
        `;
  });

  displayPagination();
  scrollToTable();
}

function displayPagination() {
  const pagination = document.getElementById('pagination');
  pagination.innerHTML = '';
  const totalPages = Math.ceil(tableData.length / rowsPerPage);

  // Adiciona botão "Anterior"
  pagination.innerHTML = `
        <li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
            <a class="page-link" href="#" onclick="changePage(${
              currentPage - 1
            }, event)">
                <i class="bx bx-chevron-left"></i>
            </a>
        </li>
    `;

  // Lógica para mostrar páginas ao redor da página atual
  let startPage = Math.max(1, currentPage - 2);
  let endPage = Math.min(totalPages, currentPage + 2);

  if (startPage > 1) {
    pagination.innerHTML += `
            <li class="page-item">
                <a class="page-link" href="#" onclick="changePage(1, event)">1</a>
            </li>
            ${
              startPage > 2
                ? '<li class="page-item disabled"><span class="page-link">...</span></li>'
                : ''
            }
        `;
  }

  for (let i = startPage; i <= endPage; i++) {
    pagination.innerHTML += `
            <li class="page-item ${i === currentPage ? 'active' : ''}">
                <a class="page-link" href="#" onclick="changePage(${i}, event)">${i}</a>
            </li>
        `;
  }

  if (endPage < totalPages) {
    pagination.innerHTML += `
            ${
              endPage < totalPages - 1
                ? '<li class="page-item disabled"><span class="page-link">...</span></li>'
                : ''
            }
            <li class="page-item">
                <a class="page-link" href="#" onclick="changePage(${totalPages}, event)">${totalPages}</a>
            </li>
        `;
  }

  // Adiciona botão "Próximo"
  pagination.innerHTML += `
        <li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
            <a class="page-link" href="#" onclick="changePage(${
              currentPage + 1
            }, event)">
                <i class="bx bx-chevron-right"></i>
            </a>
        </li>
    `;
}

function changePage(page, event) {
  if (event) {
    event.preventDefault();
  }
  if (page < 1 || page > Math.ceil(tableData.length / rowsPerPage)) {
    return;
  }
  currentPage = page;
  displayTable();
}

function generatePetition(index) {
  const data = tableData[index];
  if (!data) {
    showToast('Erro ao gerar petição: dados não encontrados', 'error');
    return;
  }

  // Se tem CPF/CNPJ gera petição normal, se não tem gera alternativa
  if (data['CPF/CNPJ'] && data['CPF/CNPJ'] !== 'Não informado') {
    const petitionText = `
        <div class="petition-content" style="text-align: justify; font-family: Arial, sans-serif; line-height: 1.5;">
          <p style="text-align: right;">AO JUÍZO DA VARA CÍVEL DA COMARCA DE MARANGUAPE-CE</p>
   
          <h3 style="text-align: center; margin-bottom: 15px;">EXECUÇÃO FISCAL</h3>
   
          <p>
              O MUNICÍPIO DE MARANGUAPE, pessoa jurídica de direito público interno, inscrito no CNPJ sob nº 07.963.051/0001-68, com endereço no Palácio da Intendência – Gabinete do Prefeito, Rua Major Napoleão Lima, nº 253, Centro, CEP n° 61940-180, por seus Procuradores Judiciais ao final subscritos, vem, respeitosamente, perante Vossa Excelência, propor em face de <strong>${
                data['Nome do Contribuinte']
              }</strong>, CPF/CNPJ: <strong>${
      data['CPF/CNPJ']
    }</strong>, com endereço na <strong>${
      data['Endereço']
    }</strong>, ação de EXECUÇÃO FISCAL DE DÍVIDA ATIVA, proveniente de débito consubstanciado na seguinte Certidão de Inscrição em Dívida Ativa nº <strong>${
      data['Certidão Número']
    }</strong>, que integra a presente petição inicial.
          </p>
   
          <p>Para tanto, requer:</p>
   
          <ol>
              <li style="margin-bottom: 10px;">A citação da parte devedora, por via postal, com Aviso de Recepção (AR), para pagar, no prazo legal, a dívida inscrita, devidamente atualizada, acrescida de juros, custas e despesas processuais, honorários advocatícios e outros encargos incidentes de que tratam a legislação tributária correlata, ou nomear bens livres e desembaraçados para garantir a execução em consonância com a legislação em vigor, sob pena de lhe serem penhorados ou arrestados tantos bens quanto bastem à plena execução da dívida;</li>
   
              <li style="margin-bottom: 10px;">Não paga a dívida ou não garantida a execução, a expedição, por via eletrônica, de ordem de bloqueio de dinheiro em depósito ou aplicação financeira, nos termos dos artigos 185-A, do Código Tributário Nacional e 854, do Código de Processo Civil e, restando infrutífera, a expedição de mandado de penhora e avaliação a recair sobre tantos bens quanto bastem à garantia integral da dívida, inclusive, imóveis, nesse caso, procedendo-se à intimação do cônjuge e à notificação do cartório de registro competente.</li>
          </ol>
   
          <p>
              Atribui-se à causa o valor atualizado de <strong>${
                data['Total (Valor atual)']
              }</strong> (${valorPorExtenso(
      data['Total (Valor atual)']
    )}), consoante o disposto no art. 6º, §4º, da Lei de Execuções Fiscais.
          </p>
   
          <p>
              Por oportuno, requer a juntada da Certidão da Dívida Ativa nº <strong>${
                data['Certidão Número']
              }</strong>, bem como do Termo de Inscrição Consolidado.
          </p>
   
          <p style="text-align: left; margin-top: 20px;">
              Nestes termos,<br>
              Pede deferimento.
          </p>
   
          <p style="text-align: left; margin-top: 20px;">
              Maranguape-CE, ${new Date().toLocaleDateString('pt-BR')}
          </p>
   
          <p style="text-align: left; margin-top: 40px;">
   <strong>Francisco Regis Freitas Matos</strong><br>
   Procurador-Geral do Município de Maranguape<br>
   OAB/CE nº 9.750
</p>

<p style="text-align: left; margin-top: 20px;">
   <strong>Edmar Nunes</strong><br>
   Assessor Jurídico<br>
   OAB/CE n° 31.552
</p>
        </div>
      `;

    try {
      document.getElementById('petitionText').innerHTML = petitionText;
      const petitionModal = new bootstrap.Modal(
        document.getElementById('petitionModal')
      );
      petitionModal.show();
    } catch (error) {
      console.error('Erro ao gerar petição:', error);
      showToast('Erro ao gerar petição. Por favor, tente novamente.', 'error');
    }
  } else {
    // Gera petição sem CPF/CNPJ com fundamentação legal
    const petitionText = `
        <div class="petition-content" style="text-align: justify; font-family: Arial, sans-serif; line-height: 1.5;">
          <p style="text-align: right;">AO JUÍZO DA VARA CÍVEL DA COMARCA DE MARANGUAPE-CE</p>
   
          <h3 style="text-align: center; margin-bottom: 15px;">EXECUÇÃO FISCAL</h3>
   
          <p>
              O MUNICÍPIO DE MARANGUAPE, pessoa jurídica de direito público interno, inscrito no CNPJ sob nº 07.963.051/0001-68, com endereço no Palácio da Intendência – Gabinete do Prefeito, Rua Major Napoleão Lima, nº 253, Centro, CEP n° 61940-180, por seus Procuradores Judiciais ao final subscritos, vem, respeitosamente, perante Vossa Excelência, propor em face de <strong>${
                data['Nome do Contribuinte']
              }</strong>, com endereço na <strong>${
      data['Endereço']
    }</strong>, ação de EXECUÇÃO FISCAL DE DÍVIDA ATIVA, nos seguintes termos:
          </p>
   
          <p>
              Ab initio, cumpre destacar que a presente execução fiscal atende aos requisitos estabelecidos no Código Tributário Nacional, bem como na Lei Federal nº. 6.830/80 - Lei de Execução Fiscal, observando-se e aplicando todas as formalidades do título executivo, sendo este líquido, certo e exigível.
          </p>
   
          <p>
              Reza o artigo 6º da Lei nº. 6.830/80 – LEF:
          </p>
   
          <blockquote style="margin-left: 20px; font-style: italic;">
              "Art. 6º - A petição inicial indicará apenas:<br>
              I - o Juiz a quem é dirigida;<br>
              II - o pedido; e<br>
              III - o requerimento para a citação."
          </blockquote>
   
          <p>
              Por sua vez, a Certidão de Dívida Ativa que instrui a inicial deverá conter os mesmos elementos do Termo de Inscrição em Dívida Ativa, nos moldes do § 5º, do art. 2º da lei supracitada, dentre os quais não se encontra elencado o CPF ou CNPJ do executado.
          </p>
   
          <p>
              Mesmo que aplicando-se os requisitos do art. 319 do CPC, ainda assim não seria admissível o indeferimento da petição inicial por ausência dos dados qualitativos faltantes, conforme dispõe o § 2º do citado artigo:
          </p>
   
          <blockquote style="margin-left: 20px; font-style: italic;">
              "§ 2º A petição inicial não será indeferida se, a despeito da falta de informações a que se refere o inciso II, for possível a citação do réu."
          </blockquote>
   
          <p>
              Cumpre destacar o teor da Súmula 558 do Superior Tribunal de Justiça: "Em ações de execução fiscal, a petição inicial não pode ser indeferida sob o fundamento da ausência de indicação do CPF e/ou RG ou CNPJ do executado."
          </p>
   
          <p>
              O débito executado está consubstanciado na Certidão de Dívida Ativa nº <strong>${
                data['Certidão Número']
              }</strong>, que segue anexa e integra a presente petição inicial para todos os fins de direito.
          </p>
   
          <p>Para tanto, requer:</p>
   
          <ol>
              <li style="margin-bottom: 10px;">A citação da parte devedora, por via postal, com Aviso de Recepção (AR), para pagar, no prazo legal, a dívida inscrita, devidamente atualizada, acrescida de juros, custas e despesas processuais, honorários advocatícios e outros encargos incidentes de que tratam a legislação tributária correlata, ou nomear bens livres e desembaraçados para garantir a execução em consonância com a legislação em vigor, sob pena de lhe serem penhorados ou arrestados tantos bens quanto bastem à plena execução da dívida;</li>
   
              <li style="margin-bottom: 10px;">Não paga a dívida ou não garantida a execução, a expedição, por via eletrônica, de ordem de bloqueio de dinheiro em depósito ou aplicação financeira, nos termos dos artigos 185-A, do Código Tributário Nacional e 854, do Código de Processo Civil e, restando infrutífera, a expedição de mandado de penhora e avaliação a recair sobre tantos bens quanto bastem à garantia integral da dívida, inclusive, imóveis, nesse caso, procedendo-se à intimação do cônjuge e à notificação do cartório de registro competente.</li>
          </ol>
   
          <p>
              Atribui-se à causa o valor atualizado de <strong>${
                data['Total (Valor atual)']
              }</strong> (${valorPorExtenso(
      data['Total (Valor atual)']
    )}), consoante o disposto no art. 6º, §4º, da Lei de Execuções Fiscais.
          </p>
   
          <p>
              Por oportuno, requer a juntada da Certidão da Dívida Ativa nº <strong>${
                data['Certidão Número']
              }</strong>, bem como do Termo de Inscrição Consolidado.
          </p>
   
          <p style="text-align: left; margin-top: 20px;">
              Nestes termos,<br>
              Pede deferimento.
          </p>
   
          <p style="text-align: left; margin-top: 20px;">
              Maranguape-CE, ${new Date().toLocaleDateString('pt-BR')}
          </p>
   
          <p style="text-align: left; margin-top: 40px;">
   <strong>Francisco Regis Freitas Matos</strong><br>
   Procurador-Geral do Município de Maranguape<br>
   OAB/CE nº 9.750
</p>

<p style="text-align: left; margin-top: 20px;">
   <strong>Edmar Nunes</strong><br>
   Assessor Jurídico<br>
   OAB/CE n° 31.552
</p>
        </div>
      `;

    try {
      document.getElementById('petitionText').innerHTML = petitionText;
      const petitionModal = new bootstrap.Modal(
        document.getElementById('petitionModal')
      );
      petitionModal.show();
    } catch (error) {
      console.error('Erro ao gerar petição:', error);
      showToast('Erro ao gerar petição. Por favor, tente novamente.', 'error');
    }
  }
}

function toggleStatus(index) {
  if (tableData[index]) {
    tableData[index].status =
      tableData[index].status === 'Pendente' ? 'Concluída' : 'Pendente';
    displayTable();
    updateDashboard();
    showToast(
      `Petição ${tableData[index].status.toLowerCase()} com sucesso!`,
      'success'
    );
  }
}

function updateDashboard() {
  const totalCount = tableData.length;
  const completedCount = tableData.filter(
    (row) => row.status === 'Concluída'
  ).length;
  const pendingCount = totalCount - completedCount;
  const totalValue = tableData.reduce((sum, row) => {
    const value = String(row['Total (Valor atual)'])
      .replace('R$', '')
      .replace(/\./g, '')
      .replace(',', '.')
      .trim();
    return sum + (parseFloat(value) || 0);
  }, 0);

  document.getElementById('totalPetitions').textContent = totalCount;
  document.getElementById('pendingPetitions').textContent = pendingCount;
  document.getElementById('completedPetitions').textContent = completedCount;
  document.getElementById(
    'totalValue'
  ).textContent = `R$ ${totalValue.toLocaleString('pt-BR', {
    minimumFractionDigits: 2,
    maximumFractionDigits: 2,
  })}`;
}

function searchTable() {
  const searchTerm = document.getElementById('searchInput').value.toLowerCase();
  const filteredData = tableData.filter(
    (row) =>
      String(row['Certidão Número']).toLowerCase().includes(searchTerm) ||
      String(row['Nome do Contribuinte']).toLowerCase().includes(searchTerm) ||
      String(row['CPF/CNPJ']).toLowerCase().includes(searchTerm)
  );
  displayFilteredTable(filteredData);
}

function filterTable(status) {
  let filteredData;
  if (status === 'all') {
    filteredData = tableData;
  } else if (status === 'completed') {
    filteredData = tableData.filter((row) => row.status === 'Concluída');
  } else {
    filteredData = tableData.filter((row) => row.status === 'Pendente');
  }
  displayFilteredTable(filteredData);
}

function displayFilteredTable(filteredData) {
  const table = document
    .getElementById('dataTable')
    .getElementsByTagName('tbody')[0];
  table.innerHTML = '';

  filteredData.forEach((row, index) => {
    const newRow = table.insertRow();
    newRow.className = `table-row-hover ${
      row.status === 'Pendente' ? 'status-pending' : 'status-completed'
    }`;

    newRow.innerHTML = `
            <td class="align-middle">
                <span class="fw-semibold">${row['Certidão Número'] || ''}</span>
            </td>
            <td class="align-middle">
                <span class="fw-semibold">${
                  row['Nome do Contribuinte'] || ''
                }</span>
            </td>
            <td class="align-middle">
                <span>${row['CPF/CNPJ'] || ''}</span>
            </td>
            <td class="align-middle">
                <div class="text-wrap">
                    ${row['Endereço'] || ''}
                </div>
            </td>
            <td class="align-middle text-end fw-bold">
                ${row['Total (Valor atual)'] || ''}
            </td>
            <td class="align-middle">
                <span class="badge ${
                  row.status === 'Pendente' ? 'bg-warning' : 'bg-success'
                }">${row.status}</span>
            </td>
            <td class="align-middle">
                <div class="btn-group" role="group">
                    <button class="btn btn-primary btn-sm" 
                            onclick="generatePetition(${index})"
                            title="Gerar Petição">
                        <i class="bx bx-file-blank"></i>
                        <span class="d-none d-md-inline ms-1">Petição</span>
                    </button>
                    <button class="btn btn-${
                      row.status === 'Pendente' ? 'success' : 'warning'
                    } btn-sm" 
                            onclick="toggleStatus(${index})"
                            title="${
                              row.status === 'Pendente' ? 'Concluir' : 'Reabrir'
                            }">
                        <i class="bx bx-${
                          row.status === 'Pendente' ? 'check' : 'refresh'
                        }"></i>
                        <span class="d-none d-md-inline ms-1">
                            ${
                              row.status === 'Pendente' ? 'Concluir' : 'Reabrir'
                            }
                        </span>
                    </button>
                </div>
            </td>
        `;
  });
}

function showToast(message, type = 'info') {
  const icon =
    type === 'success'
      ? 'bx-check-circle'
      : type === 'error'
      ? 'bx-x-circle'
      : 'bx-info-circle';

  Toastify({
    node: (() => {
      const node = document.createElement('div');
      node.innerHTML = `
                <div class="toastify-content">
                    <i class="bx ${icon} toastify-icon"></i>
                    <div class="toastify-text">${message}</div>
                </div>
            `;
      return node;
    })(),
    duration: 3000,
    close: true,
    gravity: 'top',
    position: 'right',
    className: `rounded toast-${type}`,
    stopOnFocus: true,
    onClick: function () {}, // Prevents auto-dismissal on click
  }).showToast();
}

function copyPetitionText() {
  const petitionText = document.getElementById('petitionText').innerHTML;
  const blob = new Blob([`<html><body>${petitionText}</body></html>`], {
    type: 'text/html',
  });
  const clipboardItem = new ClipboardItem({ 'text/html': blob });

  navigator.clipboard.write([clipboardItem]).then(
    () => {
      showToast('Texto da petição copiado com sucesso!', 'success');
    },
    () => {
      showToast('Erro ao copiar o texto da petição.', 'error');
    }
  );
}

function scrollToTable() {
  const tableElement = document.getElementById('dataTable');
  if (tableElement) {
    tableElement.scrollIntoView({ behavior: 'smooth', block: 'start' });
  }
}

function valorPorExtenso(valor) {
  const unidades = [
    '',
    'um',
    'dois',
    'três',
    'quatro',
    'cinco',
    'seis',
    'sete',
    'oito',
    'nove',
  ];
  const dezenas = [
    '',
    'dez',
    'vinte',
    'trinta',
    'quarenta',
    'cinquenta',
    'sessenta',
    'setenta',
    'oitenta',
    'noventa',
  ];
  const dez_a_dezenove = [
    'dez',
    'onze',
    'doze',
    'treze',
    'quatorze',
    'quinze',
    'dezesseis',
    'dezessete',
    'dezoito',
    'dezenove',
  ];
  const centenas = [
    '',
    'cento',
    'duzentos',
    'trezentos',
    'quatrocentos',
    'quinhentos',
    'seiscentos',
    'setecentos',
    'oitocentos',
    'novecentos',
  ];

  function converterGrupo(numero) {
    let resultado = '';

    // Tratamento especial para 100
    if (numero === 100) {
      return 'cem';
    }

    // Centenas
    if (numero >= 100) {
      resultado += centenas[Math.floor(numero / 100)] + ' ';
      numero %= 100;
    }

    // Dezenas e unidades
    if (numero >= 10) {
      if (numero < 20) {
        resultado += dez_a_dezenove[numero - 10];
        return resultado.trim();
      } else {
        resultado += dezenas[Math.floor(numero / 10)] + ' ';
        numero %= 10;
      }
    }

    // Unidades
    if (numero > 0) {
      resultado += unidades[numero];
    }

    return resultado.trim();
  }

  function converterMilhoes(numero) {
    const milhoes = Math.floor(numero / 1000000);
    if (milhoes > 0) {
      return milhoes === 1 ? 'um milhão' : converterGrupo(milhoes) + ' milhões';
    }
    return '';
  }

  function converterMilhares(numero) {
    const milhares = Math.floor((numero % 1000000) / 1000);
    if (milhares > 0) {
      return milhares === 1 ? 'um mil' : converterGrupo(milhares) + ' mil';
    }
    return '';
  }

  // Limpar e formatar o valor de entrada
  valor = valor.toString().replace('R$', '').trim();
  const partes = valor.split(',');
  let reais = parseInt(partes[0].replace(/\./g, ''));
  let centavos = partes[1] ? parseInt(partes[1].padEnd(2, '0')) : 0;

  if (reais === 0 && centavos === 0) {
    return 'zero reais';
  }

  let extenso = '';

  // Converter reais
  if (reais > 0) {
    const milhoes = converterMilhoes(reais);
    const milhares = converterMilhares(reais);
    const centenas = converterGrupo(reais % 1000);

    extenso =
      [milhoes, milhares, centenas].filter((parte) => parte !== '').join(' ') +
      (reais === 1 ? ' real' : ' reais');
  }

  // Converter centavos
  if (centavos > 0) {
    if (reais > 0) extenso += ' e ';
    extenso +=
      converterGrupo(centavos) + (centavos === 1 ? ' centavo' : ' centavos');
  }

  // Capitalizar primeira letra
  return extenso.charAt(0).toUpperCase() + extenso.slice(1);
}

// Inicialização
document.addEventListener('DOMContentLoaded', function () {
  // Event listeners
  document
    .getElementById('xlsxInput')
    .addEventListener('change', handleFileUpload);
  document.getElementById('searchInput').addEventListener('input', searchTable);

  // Event listeners para os botões de filtro
  document.querySelectorAll('[data-filter]').forEach((button) => {
    button.addEventListener('click', () => filterTable(button.dataset.filter));
  });

  // Inicialização do dashboard
  updateDashboard();
});
</script>
    
</body>
</html>
